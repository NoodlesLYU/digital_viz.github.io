<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Distribution map of airbnb listings in london</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <style>

body {
  margin: 0;
  padding: 0;
}

h2 {
  margin: 10px;
  font-size: 18px;
}

h3 {
  font-size: 16px;
}

p {
  margin: 10px;
}


/* Create a position for the map
   on the page */
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
}

/* Set rules for how the map overlays
   (information box and legend) will be displayed
   on the page. */
.map-overlay {
  position: absolute;
  bottom: 0;
  right: 0;
  background: #fff;
  margin-right: 20px;
  font-family: Arial, sans-serif;
  overflow: auto;
  border-radius: 3px;
}

.map-overlay1 {
  font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  position: absolute;
  width: 17%;
  top: 0;
  left: 0;
  padding: 10px;
  z-index: 1; 
}

.map-overlay1 .map-overlay1-inner {
  background-color: #fff;
  box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
  border-radius: 3px;
  padding: 10px;
  margin-bottom: 10px;
  height: 100%; 
  display: flex; 
  flex-direction: column; 
  justify-content: space-between; 
}

.map-overlay1 table {
  border: none;
  width: 100%;
}

.map-overlay1 h2 {
  line-height: 24px;
  display: block;
  margin: 0 0 10px;
}

#features {
  top: 0;
  height: 100px;
  margin-top: 20px;
  width: 250px;
}

#legend {
  padding: 10px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  line-height: 18px;
  height: 220px;
  margin-bottom: 40px;
  width: 100px;
}

.legend-key {
  display: inline-block;
  border-radius: 20%;
  width: 10px;
  height: 10px;
  margin-right: 5px;
}

/* Set the slider */
#slider {
  width: 100%;
  margin-top: 20px;
}

#price-slider {
    width: 100%;
    height: 100%;
    
    background-color: #ddd;
    outline: none;
}

#tickmarks {
    width: 100%;
}



</style>
</head>
<body>


<div id='map'></div>

<div class='map-overlay' id='legend'>
  <h3>Number of <br>listings</br></h3>
</div>

<div class='map-overlay1'>
  <div class='map-overlay1-inner'>
      <h2 id="laname">Hover over a local authority</h2>
      <table><tr><td>
       
          <input id="slider" type="range" min="200" max="1400" step="200" value="200" id="price-slider" list="tickmarks">
          <datalist id="tickmarks">
            <option value="200">
            <option value="400">
            <option value="600">
            <option value="800">
            <option value="1000">
            <option value="1200">
            <option value="1400">
          </datalist>
        
		 </td>
		 <td>
		  <label>under 200£</label>
         </td>
         </tr></table>
</div>
</div>




<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGlubHl1IiwiYSI6ImNsZWU2aDY3ZDBlMjYzd212eTVsNDcyeXUifQ.SeRfet4RVHQGf7DAiD1gYw'; 
    // Mapbox Public Access token here

    // Load a new map in the 'map' HTML div
    var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/pinlyu/clexdfx06000901n50yy4cvrb', // stylesheet location
    center: [-0.1, 51.5], // starting position [lng, lat]
    zoom: 10 // starting zoom
    });

    map.on('load', function() {    // load the map

        const layers = [
                
            '0-500',
            '500-1000',
            '1000-1500',
            '1500-2000',
            '2000-2500',
            '2500-3500',
            '3500-4500',
            '4500+'
        ];

        const colors = [
            
            '#FFEDA0',
            '#FED976',
            '#FEB24C',
            '#FD8D3C',
            '#FC4E2A',
            '#E31A1C',
            '#BD0026',
            '#800026'
        ];

        const legend = document.getElementById('legend'); // set legend

        layers.forEach((layer, i) => {
        
            const color = colors[i];
            const item = document.createElement('div');
            const key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            const value = document.createElement('span');
            value.innerHTML = `${layer}`;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);
        });

        map.addLayer({         // add layer 'listings-3' created from mapbox
            id: 'listings-3',
            type: 'circle',
            source: {
                type: 'vector',
                url: 'mapbox://pinlyu.94jzyods' // Mapbox tileset Map ID
            },
            'source-layer': 'listings-47zi0s', // name of tileset layer
            'layout': {
                'visibility': 'visible'
            },
            paint: {
                'circle-color': '#fffef7',
                'circle-opacity': 0.3,
                'circle-stroke-width': {
                    stops: [[12, 1], [17, 3], [22, 5]]  // The width properties change at different zoom levels, getting thicker
                },
                'circle-stroke-color': '#050',
                'circle-stroke-opacity': 0.3,
                'circle-radius': {
                    property: 'price',
                    stops: [                           // The circle radius varies according to the zoom level and the value of price
                        [{zoom: 12, value: 10}, 2],
                        [{zoom: 12, value: 1000}, 20],
                        [{zoom: 17, value: 10}, 4],
                        [{zoom: 17, value: 1000}, 40],
                        [{zoom: 22, value: 10}, 20],
                        [{zoom: 22, value: 1000}, 200],
                    ]
                }
            }
        });


        map.addLayer({                   // add layer 'labels' to label the circle
            'id': 'labels',
            'type': 'symbol',
            'source': 'listings-3',
            'source-layer': 'listings-47zi0s', // name of tilesets
            'layout': {
                'text-field': '{price}£',
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-size': {
                    stops: [[12, 2], [17, 10],[22,20]]
                }
            },
                'paint': {
                    'text-color': 'rgba(0,0,0,0.6)'
                }
        });
                    

        var slider = document.getElementById('slider');   // set the slider

        const layers1 = map.getStyle().layers.filter(layer => layer.id === 'listings-3' || layer.id === 'labels');
        
        slider.addEventListener('input', function(e) {
            
            var price = parseInt(slider.value);

            var filter = ['<=', ['get', 'price'], price]; // set the filter
            
            if (price >= slider.max) {
                document.querySelector('label').innerHTML = 'ALL price';
                layers1.forEach(layer => {
                map.setFilter(layer.id);
                });
          
            } else {
                document.querySelector('label').innerHTML = 'under ' + price + '£';
                layers1.forEach(layer => {
                map.setFilter(layer.id, filter);
                });
            }
        
        });

        // Set the initial filter to show listings with price <= 200 
        const initialFilter = ['<=', ['get', 'price'], 200];
        layers1.forEach(layer => {
            map.setFilter(layer.id, initialFilter);
        });

    });
 
    var mypopup = new mapboxgl.Popup({offset:[150,50],closeButton: false}); // set popup

    map.on('mouseover', 'listings-3', function (e) {
          mypopup
          .setLngLat(e.features[0].geometry.coordinates)
          .setHTML('<img src="' + e.features[0].properties.picture_url + '"style= "max-width: 220px; max-height: 220px;">' +"<h3>" + e.features[0].properties.description + "</h3>")
          .addTo(map);
    });

            // Change the cursor to a pointer when the mouse is over the layer.
    map.on('mouseenter', 'listings-3', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

            // Change it back to a pointer when it leaves and remove the popup window.
    map.on('mouseleave', 'listings-3', function () {
        map.getCanvas().style.cursor = '';
        mypopup.remove();
    });


    const listingsLayer = map.getLayer('listings-3');

  // Add a click event listener to the layer
    map.on('click', 'listings-3', function(e) {

        // Get the link URL from the clicked feature's properties
        const linkUrl = e.features[0].properties.url;
  
        // Open the link in a new tab
        window.open(linkUrl, '_blank');
    });


    map.on('load', function() {

        map.addLayer({        //Add the fill layer. It is not visible (opacity 0) and is used only as the basis of the hover selection
            id: 'LocalAuthorities',
            type: 'fill',
            source: {
                type: 'vector',
                url: 'mapbox://pinlyu.bxmf6kl9' // Mapbox tileset Map ID
            },
            'source-layer': 'neighbourhoods-clglw3', // name of tilesets
            'layout': {
                'visibility': 'visible'
            },
            paint: {
                'fill-color': '#fff',
                'fill-opacity': 0
            }
        });

        map.addLayer({
            id: 'lahighlight',
            type: 'line',
            source: {
                type: 'vector',
                url: 'mapbox://pinlyu.bxmf6kl9' // Your Mapbox tileset Map ID
            },
            'source-layer': 'neighbourhoods-clglw3', // name of tilesets
            paint: {
                'line-color': '#3bb2d0',
                'line-width': 3
            },
            filter: ['==', 'neighbourhood', '']
        });


        map.on('mousemove', function(e) {       // This is the main event listner which is triggered when the mouse moves
            var la = map.queryRenderedFeatures(e.point, {   // This queries whether the mouse is over an object in the LocalAuthorities layer
                layers: ['LocalAuthorities']
            });

            if (la.length==1) {   // This if statement is run when the mouse is over a local authority
            
                var laName = la[0].properties.neighbourhood;
                map.setFilter('lahighlight', ['==', 'neighbourhood', laName]);

                document.getElementById('laname').innerHTML = la[0].properties.neighbourhood; // Change the name in the top left box to show the local authority name
        
                console.log(la[0].id);
                console.log(la);

            } else {
                map.setFilter('lahighlight', ['==','neighbourhood','null']);
                console.log('No features');
                document.getElementById('laname').innerHTML = "Hover over a local authority";
            }

        });

        map.on('click', function(e) {       // Add click event listener to the map
            var la = map.queryRenderedFeatures(e.point, {   // Query whether a local authority is clicked
                layers: ['LocalAuthorities']
            });

            if (la.length==1) {   // If a local authority is clicked, zoom in on its location
              
                map.flyTo({
                center: e.lngLat,
                zoom: 15,
                essential: true
                });
            }
        });

    })

</script>
</body>
</html>